<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QuantBroker Dashboard Demo</title>
    <link rel="stylesheet" href="tailwind.min.css" />
    <script src="react.min.js"></script>
    <script src="react-dom.min.js"></script>
    <script src="babel.min.js"></script>
    <script src="Recharts.min.js"></script>
  </head>
  <body class="min-h-screen">
    <div id="root"></div>
    <script type="text/babel" data-presets="typescript,react">
      const {
        useState,
        useEffect,
        useMemo,
        useCallback,
        useRef,
        createContext,
        useContext,
      } = React;

      function DynamicBackground() {
        const [gradient, setGradient] = useState(
          "from-blue-800 via-purple-800 to-indigo-800",
        );
        useEffect(() => {
          const colors = [
            "from-blue-800 via-purple-800 to-indigo-800",
            "from-teal-700 via-cyan-700 to-blue-700",
            "from-rose-800 via-pink-800 to-purple-800",
          ];
          let i = 0;
          const id = setInterval(() => {
            setGradient(colors[i % colors.length]);
            i += 1;
          }, 8000);
          return () => clearInterval(id);
        }, []);
        return (
          <div
            className={`fixed inset-0 -z-10 bg-gradient-to-br ${gradient} transition-colors duration-1000`}
          />
        );
      }

      function StarfieldOverlay() {
        const canvasRef = useRef(null);
        useEffect(() => {
          const canvas = canvasRef.current;
          if (!canvas) return;
          const ctx = canvas.getContext("2d");
          if (!ctx) return;
          let animationId;
          const stars = Array.from({ length: 100 }, () => ({
            x: Math.random() * window.innerWidth,
            y: Math.random() * window.innerHeight,
            r: Math.random() * 1.5 + 0.5,
            v: Math.random() * 0.5 + 0.2,
          }));
          const resize = () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
          };
          resize();
          window.addEventListener("resize", resize);
          const render = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "rgba(255,255,255,0.8)";
            stars.forEach((s) => {
              s.y -= s.v;
              if (s.y < 0) s.y = canvas.height;
              ctx.beginPath();
              ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
              ctx.fill();
            });
            animationId = requestAnimationFrame(render);
          };
          animationId = requestAnimationFrame(render);
          return () => {
            window.removeEventListener("resize", resize);
            cancelAnimationFrame(animationId);
          };
        }, []);
        return (
          <canvas
            ref={canvasRef}
            className="pointer-events-none fixed inset-0 -z-10"
          />
        );
      }

      function LoadingSpinner() {
        return (
          <div className="flex justify-center items-center py-4">
            <div className="h-6 w-6 animate-spin rounded-full border-2 border-current border-t-transparent" />
          </div>
        );
      }

      function AnimatedNumber({ value, duration = 800 }) {
        const [display, setDisplay] = useState(0);
        const startRef = useRef(null);
        const prevValue = useRef(value);
        useEffect(() => {
          const start = performance.now();
          startRef.current = start;
          const from = prevValue.current;
          const animate = (now) => {
            const progress = Math.min((now - start) / duration, 1);
            setDisplay(from + (value - from) * progress);
            if (progress < 1) requestAnimationFrame(animate);
            else prevValue.current = value;
          };
          requestAnimationFrame(animate);
        }, [value, duration]);
        return <span>{Math.round(display).toLocaleString()}</span>;
      }

      function Heatmap({ data }) {
        const max = Math.max(...data.flat().map(Math.abs));
        return (
          <div
            className="grid"
            style={{
              gridTemplateColumns: `repeat(${data[0]?.length || 0}, 1fr)`,
            }}
          >
            {data.map((row, i) =>
              row.map((v, j) => {
                const intensity = max ? Math.abs(v) / max : 0;
                const color =
                  v >= 0
                    ? `rgba(59,130,246,${intensity})`
                    : `rgba(220,38,38,${intensity})`;
                return (
                  <div
                    key={`${i}-${j}`}
                    className="h-6 flex items-center justify-center text-xs"
                    style={{ backgroundColor: color }}
                  >
                    {v.toFixed(2)}
                  </div>
                );
              }),
            )}
          </div>
        );
      }

      function exportToCSV(data, filename) {
        if (!data.length) return;
        const headers = Object.keys(data[0]);
        const csv = [
          headers.join(","),
          ...data.map((row) =>
            headers.map((h) => JSON.stringify(row[h] ?? "")).join(","),
          ),
        ].join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = filename;
        link.click();
        URL.revokeObjectURL(url);
      }

      function Button({
        variant = "default",
        size = "default",
        className = "",
        ...props
      }) {
        const variantClass =
          variant === "outline"
            ? "border border-gray-300 bg-white hover:bg-gray-100"
            : "bg-blue-600 text-white hover:bg-blue-700";
        const sizeClass =
          size === "sm"
            ? "px-3 py-1 text-sm"
            : size === "xs"
              ? "px-2 py-0.5 text-xs"
              : "px-4 py-2";
        return (
          <button
            className={`${variantClass} ${sizeClass} rounded ${className}`}
            {...props}
          />
        );
      }

      function Input({ className = "", ...props }) {
        return (
          <input
            className={`border rounded px-2 py-1 focus:outline-none focus:ring ${className}`}
            {...props}
          />
        );
      }

      function Card({ className = "", ...props }) {
        return (
          <div
            className={`bg-white p-4 rounded shadow ${className}`}
            {...props}
          />
        );
      }
      function CardHeader({ className = "", ...props }) {
        return <div className={`font-semibold mb-2 ${className}`} {...props} />;
      }
      function CardContent({ className = "", ...props }) {
        return <div className={className} {...props} />;
      }

      function DatePicker({ value, onChange }) {
        return (
          <div className="flex space-x-2">
            <input
              type="date"
              value={value[0].toISOString().slice(0, 10)}
              onChange={(e) => onChange([new Date(e.target.value), value[1]])}
              className="border rounded px-2 py-1"
            />
            <span>to</span>
            <input
              type="date"
              value={value[1].toISOString().slice(0, 10)}
              onChange={(e) => onChange([value[0], new Date(e.target.value)])}
              className="border rounded px-2 py-1"
            />
          </div>
        );
      }

      function Select({ className = "", children, ...props }) {
        return (
          <select
            className={`border rounded px-2 py-1 bg-white ${className}`}
            {...props}
          >
            {children}
          </select>
        );
      }

      function Slider({ className = "", ...props }) {
        return (
          <input type="range" className={`w-full ${className}`} {...props} />
        );
      }

      function Switch({ checked, onCheckedChange }) {
        return (
          <label className="inline-flex items-center cursor-pointer">
            <input
              type="checkbox"
              checked={checked}
              onChange={(e) => onCheckedChange(e.target.checked)}
              className="sr-only"
            />
            <span
              className={`h-4 w-8 rounded-full transition-colors ${checked ? "bg-blue-600" : "bg-gray-300"}`}
            >
              <span
                className={`block h-4 w-4 bg-white rounded-full shadow transform transition-transform ${checked ? "translate-x-4" : "translate-x-0"}`}
              />
            </span>
          </label>
        );
      }

      const TabsContext = createContext(null);
      function Tabs({ value, onValueChange, children, className = "" }) {
        return (
          <TabsContext.Provider value={{ value, onValueChange }}>
            <div className={className}>{children}</div>
          </TabsContext.Provider>
        );
      }
      function TabsList({ children, className = "" }) {
        return <div className={`flex ${className}`}>{children}</div>;
      }
      function TabsTrigger({ value, children, className = "" }) {
        const ctx = useContext(TabsContext);
        if (!ctx) return null;
        const active = ctx.value === value;
        return (
          <button
            className={`${active ? "font-bold border-b-2" : ""} px-3 py-1 ${className}`}
            onClick={() => ctx.onValueChange(value)}
          >
            {children}
          </button>
        );
      }
      function TabsContent({ value, children }) {
        const ctx = useContext(TabsContext);
        if (!ctx || ctx.value !== value) return null;
        return <div>{children}</div>;
      }

      function DatabaseViewer({ apiBase }) {
        const [tables, setTables] = useState([]);
        const [table, setTable] = useState("");
        const [data, setData] = useState([]);
        const [error, setError] = useState(null);
        useEffect(() => {
          fetch(`${apiBase}/api/tables`)
            .then((r) => r.json())
            .then((d) => setTables(d.tables || []))
            .catch((e) => setError(e.message));
        }, [apiBase]);
        useEffect(() => {
          if (!table) return;
          fetch(`${apiBase}/api/table/${table}`)
            .then((r) => r.json())
            .then((d) => setData(d.records || d.data || []))
            .catch((e) => setError(e.message));
        }, [apiBase, table]);
        return (
          <div className="space-y-4">
            {error && <div className="text-red-600">{error}</div>}
            <div className="flex items-center space-x-4">
              <Select
                value={table}
                onChange={(e) => setTable(e.target.value)}
                className="w-48"
              >
                <option value="" disabled>
                  Choose table
                </option>
                {tables.map((t) => (
                  <option key={t} value={t}>
                    {t}
                  </option>
                ))}
              </Select>
              <Button
                variant="outline"
                size="sm"
                onClick={() => exportToCSV(data, `${table}.csv`)}
                disabled={!data.length}
              >
                Export
              </Button>
            </div>
            <div className="overflow-auto max-h-96">
              <table className="min-w-full text-sm">
                <thead>
                  <tr>
                    {data[0] &&
                      Object.keys(data[0]).map((h) => (
                        <th key={h} className="px-2 py-1 text-left">
                          {h}
                        </th>
                      ))}
                  </tr>
                </thead>
                <tbody>
                  {data.map((row, i) => (
                    <tr key={i} className="border-t">
                      {Object.keys(row).map((k) => (
                        <td key={k} className="px-2 py-1 whitespace-nowrap">
                          {String(row[k])}
                        </td>
                      ))}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        );
      }

      function PortfolioAllocationDashboard() {
        const [activeTab, setActiveTab] = useState("allocation");
        const [themeDark, setThemeDark] = useState(false);
        const [liveTrading, setLiveTrading] = useState(false);
        const [dateRange, setDateRange] = useState([
          new Date(Date.now() - 30 * 24 * 3600 * 1000),
          new Date(),
        ]);
        const [assets, setAssets] = useState([]);
        const [filter, setFilter] = useState("");
        const [selectedAssets, setSelectedAssets] = useState([]);
        const [allocations, setAllocations] = useState([]);
        const [efficientFrontier, setEfficientFrontier] = useState([]);
        const [accountMetrics, setAccountMetrics] = useState([]);
        const [portfolioReturns, setPortfolioReturns] = useState([]);
        const [correlations, setCorrelations] = useState([]);
        const [varData, setVarData] = useState([]);
        const [errors, setErrors] = useState({
          assets: null,
          frontier: null,
          optimize: null,
          account: null,
          returns: null,
          corr: null,
          var: null,
        });
        const [loading, setLoading] = useState(false);

        const safeJson = async (res, endpoint) => {
          if (res.status === 404)
            throw new Error(`Endpoint not found: ${endpoint}`);
          if (!res.ok)
            throw new Error(`Error ${res.status}: ${res.statusText}`);
          const ct = res.headers.get("content-type") || "";
          if (!ct.includes("application/json"))
            throw new Error(`Unexpected content-type: ${ct}`);
          return res.json();
        };

        const API_BASE_PAPER = "";
        const API_BASE_LIVE = "";

        const fetchData = useCallback(
          async (endpoint, key, setter) => {
            try {
              const apiBase = liveTrading ? API_BASE_LIVE : API_BASE_PAPER;
              const url = `${apiBase}${endpoint}`;
              const res = await fetch(url);
              const data = await safeJson(res, endpoint);
              setter(data);
              setErrors((prev) => ({ ...prev, [key]: null }));
            } catch (e) {
              console.error(e);
              setErrors((prev) => ({ ...prev, [key]: e.message }));
            }
          },
          [liveTrading],
        );

        useEffect(() => {
          fetchData("/api/assets", "assets", setAssets);
          fetchData(
            "/api/efficient_frontier",
            "frontier",
            setEfficientFrontier,
          );
        }, [fetchData]);
        useEffect(() => {
          if (!selectedAssets.length) return;
          setLoading(true);
          fetchData("/api/optimize", "optimize", setAllocations).finally(() =>
            setLoading(false),
          );
        }, [selectedAssets, fetchData]);
        useEffect(() => {
          if (activeTab === "account")
            fetchData("/api/account_metrics", "account", setAccountMetrics);
        }, [activeTab, fetchData]);
        useEffect(() => {
          if (activeTab === "returns")
            fetchData("/api/portfolio_returns", "returns", setPortfolioReturns);
          fetchData("/api/correlations", "corr", setCorrelations);
          fetchData(
            `/api/var?start=${dateRange[0].toISOString()}&end=${dateRange[1].toISOString()}`,
            "var",
            setVarData,
          );
        }, [activeTab, dateRange, fetchData]);

        const filteredAssets = useMemo(
          () =>
            assets.filter((a) =>
              a.toLowerCase().includes(filter.toLowerCase()),
            ),
          [assets, filter],
        );
        const errorMessages = useMemo(
          () => Object.values(errors).filter(Boolean),
          [errors],
        );

        return (
          <div
            className={
              themeDark
                ? "min-h-screen bg-gray-900 text-white"
                : "min-h-screen bg-gray-100 text-gray-900"
            }
          >
            <DynamicBackground />
            <StarfieldOverlay />
            {loading && (
              <div className="absolute inset-0 flex items-center justify-center bg-black/40">
                <LoadingSpinner />
              </div>
            )}
            <header className="p-6 flex justify-between items-center">
              <h1 className="text-3xl font-bold">QuantBroker Dashboard</h1>
              <div className="flex items-center space-x-4">
                <div className="flex items-center space-x-1">
                  <span className="text-sm">Paper</span>
                  <Switch
                    checked={liveTrading}
                    onCheckedChange={setLiveTrading}
                  />
                  <span className="text-sm">Live</span>
                </div>
                <Switch checked={themeDark} onCheckedChange={setThemeDark} />
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => exportToCSV(allocations, "allocations.csv")}
                >
                  ⬇ Export Allocations
                </Button>
              </div>
            </header>
            {errorMessages.length > 0 && (
              <div className="mx-6 my-4 space-y-2">
                {errorMessages.map((msg, i) => (
                  <div
                    key={i}
                    className="rounded-md bg-red-600/80 p-2 text-sm text-white"
                  >
                    {msg}
                  </div>
                ))}
              </div>
            )}
            <Card className="mx-6 rounded-2xl shadow-xl p-4 bg-white/60 dark:bg-gray-800/60 backdrop-blur-md">
              <Tabs
                value={activeTab}
                onValueChange={setActiveTab}
                className="mb-6"
              >
                <TabsList className="bg-white dark:bg-gray-800 rounded-full p-1">
                  <TabsTrigger value="allocation" className="w-1/4">
                    Allocation
                  </TabsTrigger>
                  <TabsTrigger value="account" className="w-1/4">
                    Account
                  </TabsTrigger>
                  <TabsTrigger value="returns" className="w-1/4">
                    Returns
                  </TabsTrigger>
                  <TabsTrigger value="database" className="w-1/4">
                    Database
                  </TabsTrigger>
                </TabsList>
                <TabsContent value="allocation">
                  <div className="grid grid-cols-12 gap-6">
                    <aside className="col-span-3 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                      <Input
                        placeholder="Search assets"
                        value={filter}
                        onChange={(e) => setFilter(e.target.value)}
                        className="mb-3"
                      />
                      <div className="max-h-60 overflow-auto">
                        {filteredAssets.map((a) => (
                          <div
                            key={a}
                            className="flex justify-between py-1 border-b"
                          >
                            <span>{a}</span>
                            <Button
                              size="xs"
                              onClick={() =>
                                setSelectedAssets((prev) =>
                                  prev.includes(a)
                                    ? prev.filter((x) => x !== a)
                                    : [...prev, a],
                                )
                              }
                            >
                              {selectedAssets.includes(a) ? "−" : "+"}
                            </Button>
                          </div>
                        ))}
                      </div>
                    </aside>
                    <main className="col-span-9 space-y-6">
                      <div className="grid grid-cols-2 gap-6">
                        <Card>
                          <CardHeader>Efficient Frontier</CardHeader>
                          <CardContent>
                            <Recharts.ResponsiveContainer
                              width="100%"
                              height={200}
                            >
                              <Recharts.LineChart data={efficientFrontier}>
                                <Recharts.Defs>
                                  <linearGradient
                                    id="frontierGradient"
                                    x1="0"
                                    y1="0"
                                    x2="0"
                                    y2="1"
                                  >
                                    <stop
                                      offset="5%"
                                      stopColor="#2563eb"
                                      stopOpacity={0.8}
                                    />
                                    <stop
                                      offset="95%"
                                      stopColor="#2563eb"
                                      stopOpacity={0}
                                    />
                                  </linearGradient>
                                </Recharts.Defs>
                                <Recharts.CartesianGrid strokeDasharray="3 3" />
                                <Recharts.XAxis dataKey="risk" />
                                <Recharts.YAxis dataKey="return" />
                                <Recharts.Tooltip />
                                <Recharts.Line
                                  type="monotone"
                                  dataKey="return"
                                  stroke="#2563eb"
                                  fill="url(#frontierGradient)"
                                />
                              </Recharts.LineChart>
                            </Recharts.ResponsiveContainer>
                          </CardContent>
                        </Card>
                        <Card>
                          <CardHeader>Value at Risk</CardHeader>
                          <CardContent>
                            <Recharts.ResponsiveContainer
                              width="100%"
                              height={200}
                            >
                              <Recharts.LineChart data={varData}>
                                <Recharts.Defs>
                                  <linearGradient
                                    id="varGradient"
                                    x1="0"
                                    y1="0"
                                    x2="0"
                                    y2="1"
                                  >
                                    <stop
                                      offset="5%"
                                      stopColor="#dc2626"
                                      stopOpacity={0.8}
                                    />
                                    <stop
                                      offset="95%"
                                      stopColor="#dc2626"
                                      stopOpacity={0}
                                    />
                                  </linearGradient>
                                </Recharts.Defs>
                                <Recharts.XAxis dataKey="date" />
                                <Recharts.YAxis />
                                <Recharts.Tooltip />
                                <Recharts.Line
                                  type="monotone"
                                  dataKey="var"
                                  stroke="#dc2626"
                                  fill="url(#varGradient)"
                                />
                              </Recharts.LineChart>
                            </Recharts.ResponsiveContainer>
                          </CardContent>
                        </Card>
                      </div>
                      <Card>
                        <CardHeader>Correlations</CardHeader>
                        <CardContent>
                          <Recharts.ResponsiveContainer
                            width="100%"
                            height={200}
                          >
                            <Heatmap data={correlations} />
                          </Recharts.ResponsiveContainer>
                        </CardContent>
                      </Card>
                    </main>
                  </div>
                </TabsContent>
                <TabsContent value="account">
                  <div className="grid grid-cols-4 gap-6">
                    {accountMetrics.map((m) => (
                      <Card
                        key={m.name}
                        className="transition-transform hover:scale-105 hover:shadow-xl"
                      >
                        <CardHeader>{m.name}</CardHeader>
                        <CardContent>
                          <AnimatedNumber value={m.value} />
                        </CardContent>
                      </Card>
                    ))}
                  </div>
                </TabsContent>
                <TabsContent value="returns">
                  <div className="flex items-center mb-4 space-x-4">
                    <DatePicker value={dateRange} onChange={setDateRange} />
                  </div>
                  {portfolioReturns.map(({ strategy, returns }) => (
                    <Card key={strategy} className="mb-6">
                      <CardHeader>{strategy}</CardHeader>
                      <CardContent>
                        <Recharts.ResponsiveContainer width="100%" height={200}>
                          <Recharts.LineChart
                            data={returns.map((v, i) => ({ x: i, y: v }))}
                          >
                            <Recharts.Defs>
                              <linearGradient
                                id="returnGradient"
                                x1="0"
                                y1="0"
                                x2="0"
                                y2="1"
                              >
                                <stop
                                  offset="5%"
                                  stopColor="#10b981"
                                  stopOpacity={0.8}
                                />
                                <stop
                                  offset="95%"
                                  stopColor="#10b981"
                                  stopOpacity={0}
                                />
                              </linearGradient>
                            </Recharts.Defs>
                            <Recharts.CartesianGrid strokeDasharray="3 3" />
                            <Recharts.XAxis dataKey="x" />
                            <Recharts.YAxis />
                            <Recharts.Tooltip />
                            <Recharts.Line
                              type="monotone"
                              dataKey="y"
                              stroke="#10b981"
                              dot={false}
                              fill="url(#returnGradient)"
                            />
                          </Recharts.LineChart>
                        </Recharts.ResponsiveContainer>
                      </CardContent>
                    </Card>
                  ))}
                </TabsContent>
                <TabsContent value="database">
                  <DatabaseViewer
                    apiBase={liveTrading ? API_BASE_LIVE : API_BASE_PAPER}
                  />
                </TabsContent>
              </Tabs>
            </Card>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(
        <PortfolioAllocationDashboard />,
      );
    </script>
  </body>
</html>
